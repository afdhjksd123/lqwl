<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="yes" name="apple-touch-fullscreen">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="320" name="MobileOptimized">
  <title>请在浏览器中打开</title>
  <style>
    /* 基础样式重置 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    body {
      background-color: #f5f5f5;
      min-height: 100vh;
    }

    /* 三点加载动画样式 */
    .container {
      width: 100px;
      height: 100px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      animation: rotate-move 2s ease-in-out infinite;
      z-index: 10001; /* 加载动画在最上层 */
    }

    .dot {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background-color: #000;
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      margin: auto;
    }

    .dot-3 { background-color: #f74d75; animation: dot-3-move 2s ease infinite; }
    .dot-2 { background-color: #10beae; animation: dot-2-move 2s ease infinite; }
    .dot-1 { background-color: #ffe386; animation: dot-1-move 2s ease infinite; }

    @keyframes dot-3-move {
      20% { transform: scale(1) }
      45% { transform: translateY(-18px) scale(.45) }
      60% { transform: translateY(-25px) scale(.45) }
      80% { transform: translateY(-25px) scale(.45) }
      100% { transform: translateY(0px) scale(1) }
    }

    @keyframes dot-2-move {
      20% { transform: scale(1) }
      45% { transform: translate(-16px, 12px) scale(.45) }
      60% { transform: translate(-20px, 15px) scale(.45) }
      80% { transform: translate(-20px, 15px) scale(.45) }
      100% { transform: translateY(0px) scale(1) }
    }

    @keyframes dot-1-move {
      20% { transform: scale(1) }
      45% { transform: translate(16px, 12px) scale(.45) }
      60% { transform: translate(20px, 15px) scale(.45) }
      80% { transform: translate(20px, 15px) scale(.45) }
      100% { transform: translateY(0px) scale(1) }
    }

    @keyframes rotate-move {
      55% { transform: translate(-50%, -50%) rotate(0deg) }
      80% { transform: translate(-50%, -50%) rotate(360deg) }
      100% { transform: translate(-50%, -50%) rotate(360deg) }
    }

    /* 错误提示样式 */
    .error-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      padding: 20px;
      display: none;
    }
    
    .error-message h3 {
      color: #f74d75;
      font-size: 18px;
      margin-bottom: 10px;
    }
    
    .error-message p {
      color: #666;
      font-size: 14px;
    }

    /* 应用内提示弹窗样式 - 强制模式优化 */
    .app-prompt-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      z-index: 30000;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .app-prompt-content {
      width: 100%;
      max-width: 400px;
      background-color: white;
      border-radius: 16px;
      padding: 30px 20px;
      text-align: center;
      position: relative;
      animation: popup 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    
    @keyframes popup {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .app-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      border-radius: 50%;
      background-color: #f7f7f7;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .app-icon i {
      font-size: 40px;
      color: #f74d75;
    }
    
    .app-prompt-content h2 {
      color: #333;
      font-size: 22px;
      margin-bottom: 15px;
    }
    
    .app-prompt-content p {
      color: #666;
      font-size: 15px;
      line-height: 1.6;
      margin-bottom: 25px;
      padding: 0 10px;
    }
  </style>
  <!-- 引入Font Awesome图标库 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  <!-- 应用内打开提示弹窗 - 强制模式 -->
  <div class="app-prompt-modal" id="appPromptModal">
    <div class="app-prompt-content">
      <div class="app-icon">
        <i class="fas fa-external-link-alt"></i>
      </div>
      <h2>请在浏览器中打开</h2>
      <p id="promptDescription">为了获得更好的体验，请点击右上角菜单在浏览器打开</p>
    </div>
  </div>
  
  <!-- 加载动画容器 -->
  <div class="container" id="container">
    <div class="dot dot-1"></div>
    <div class="dot dot-2"></div>
    <div class="dot dot-3"></div>
  </div>
  
  <!-- 错误提示 -->
  <div class="error-message" id="errorMessage">
    <h3>加载失败</h3>
    <p id="errorDetails">链接不存在</p>
  </div>

  <script>
    // 存储目标URL
    let targetUrl = null;
    let countdownInterval = null;
    
    // 检测是否在微信、QQ、支付宝等应用内打开
    function detectAppEnvironment() {
      const userAgent = navigator.userAgent.toLowerCase();
      
      // 检测微信
      const isWeChat = /micromessenger/.test(userAgent);
      // 检测QQ
      const isQQ = /qq\//.test(userAgent) && !/mqqbrowser/.test(userAgent);
      // 检测支付宝
      const isAlipay = /alipayclient/.test(userAgent);
      
      return {
        isWeChat,
        isQQ,
        isAlipay,
        isInApp: isWeChat || isQQ || isAlipay,
        appName: isWeChat ? '微信' : (isQQ ? 'QQ' : (isAlipay ? '支付宝' : ''))
      };
    }
    
    // 显示应用内打开提示弹窗 - 强制模式
    function showAppPromptModal() {
      const appPromptModal = document.getElementById('appPromptModal');
      appPromptModal.style.display = 'flex';
      
      // 根据不同应用显示不同提示
      const env = detectAppEnvironment();
      let descriptionText;
      
      if (env.isWeChat) {
        descriptionText = "为了获得更好的体验，请通过右上角菜单在浏览器中打开";
      } else if (env.isQQ) {
        descriptionText = "为了获得更好的体验，请通过右上角菜单在浏览器中打开";
      } else if (env.isAlipay) {
        descriptionText = "为了获得更好的体验，请通过右上角菜单在浏览器中打开";
      }
      
      // 更新提示文本
      document.getElementById('promptDescription').textContent = descriptionText;
    }

    // 处理URL参数，获取key
    const params = new URLSearchParams(window.location.search);
    const key = params.get('key');
    const apiUrl = 'https://fh.qsjie.top/api/keyapi.php'; // 原API地址
    
    // 检查是否有有效的key
    if (key) {
      // 从API获取密钥对应的编码
      fetch(apiUrl + '?key=' + encodeURIComponent(key))
        .then(response => {
          if (!response.ok) {
            throw new Error('网络响应不正常');
          }
          return response.json();
        })
        .then(data => {
          if (data.success && data.encoded_url) {
            // 解码URL
            targetUrl = atob(data.encoded_url);
            
            // 验证URL有效性（确保是http/https链接）
            if (targetUrl.startsWith("http://") || targetUrl.startsWith("https://")) {
              // 强制显示引导弹窗，无论是否在应用内
              document.getElementById("container").style.display = "none";
              showAppPromptModal();
              
              console.log('目标链接:', targetUrl);
            } else {
              showError('无效的链接地址（需以http/https开头）');
            }
          } else {
            showError(data.message || '未找到对应的链接');
          }
        })
        .catch(error => {
          console.error('获取链接失败:', error);
          showError('获取链接失败: ' + error.message);
        });
    } else {
      showError('禁止滥用');
    }
    
    // 显示错误信息
    function showError(message) {
      document.getElementById("container").style.display = "none";
      document.getElementById("errorDetails").textContent = message;
      document.getElementById("errorMessage").style.display = "block";
    }
  </script>
</body>
</html>
