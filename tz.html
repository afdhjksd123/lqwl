<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="yes" name="apple-touch-fullscreen">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="320" name="MobileOptimized">
  <title>页面跳转中</title>
  <style>
    /* 基础样式确保页面可见 */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: #ffffff;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* 三点加载动画样式 */
    .container {
      width: 100px;
      height: 100px;
      position: relative;
      animation: rotate-move 2s ease-in-out infinite;
      display: block; /* 确保初始可见 */
    }

    .dot {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background-color: #000;
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      margin: auto;
    }

    .dot-3 { background-color: #f74d75; animation: dot-3-move 2s ease infinite; }
    .dot-2 { background-color: #10beae; animation: dot-2-move 2s ease infinite; }
    .dot-1 { background-color: #ffe386; animation: dot-1-move 2s ease infinite; }

    @keyframes dot-3-move {
      20% { transform: scale(1) }
      45% { transform: translateY(-18px) scale(.45) }
      60% { transform: translateY(-25px) scale(.45) }
      80% { transform: translateY(-25px) scale(.45) }
      100% { transform: translateY(0px) scale(1) }
    }

    @keyframes dot-2-move {
      20% { transform: scale(1) }
      45% { transform: translate(-16px, 12px) scale(.45) }
      60% { transform: translate(-20px, 15px) scale(.45) }
      80% { transform: translate(-20px, 15px) scale(.45) }
      100% { transform: translateY(0px) scale(1) }
    }

    @keyframes dot-1-move {
      20% { transform: scale(1) }
      45% { transform: translate(16px, 12px) scale(.45) }
      60% { transform: translate(20px, 15px) scale(.45) }
      80% { transform: translate(20px, 15px) scale(.45) }
      100% { transform: translateY(0px) scale(1) }
    }

    @keyframes rotate-move {
      55% { transform: rotate(0deg) }
      80% { transform: rotate(360deg) }
      100% { transform: rotate(360deg) }
    }

    /* 错误提示样式 */
    .error-message {
      text-align: center;
      padding: 20px;
      display: none;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .error-message h3 {
      color: #f74d75;
      font-size: 18px;
      margin-bottom: 10px;
    }
    
    .error-message p {
      color: #666;
      font-size: 14px;
    }

    /* 404错误样式 */
    .error-404 {
      text-align: center;
      padding: 20px;
      display: none;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .error-404 h2 {
      color: #f74d75;
      font-size: 72px;
      margin: 0 0 20px 0;
    }
    
    .error-404 h3 {
      color: #333;
      font-size: 24px;
      margin-bottom: 10px;
    }
    
    .error-404 p {
      color: #666;
      font-size: 16px;
      max-width: 500px;
    }

    /* 网络错误提示 */
    .network-error {
      text-align: center;
      padding: 20px;
      display: none;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
  </style>
  <!-- 引入Font Awesome图标库 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  <!-- 加载动画容器 - 初始状态可见 -->
  <div class="container" id="container">
    <div class="dot dot-1"></div>
    <div class="dot dot-2"></div>
    <div class="dot dot-3"></div>
  </div>
  
  <!-- 错误提示 -->
  <div class="error-message" id="errorMessage">
    <h3>加载失败</h3>
    <p id="errorDetails">链接不存在</p>
  </div>
  
  <!-- 404错误提示 -->
  <div class="error-404" id="error404">
    <h2>404</h2>
    <h3>页面未找到</h3>
    <p>抱歉，您访问的内容不存在或已被移除</p>
  </div>

  <!-- 网络错误提示 -->
  <div class="network-error" id="networkError">
    <h3><i class="fas fa-wifi-slash"></i> 网络错误</h3>
    <p>无法连接到服务器，请检查网络后重试</p>
    <button onclick="window.location.reload()" style="margin-top:15px;padding:8px 16px;background:#f74d75;color:white;border:none;border-radius:4px;cursor:pointer;">
      重试
    </button>
  </div>

  <script>
    // 确保DOM完全加载后执行
    document.addEventListener('DOMContentLoaded', function() {
      // 处理URL参数，获取key
      var params = new URLSearchParams(window.location.search);
      var key = params.get('key');
      var apiUrl = 'https://dns.qsjie.top/api/keyapi.php';
      var defaultUrl = 'https://www.gov.cn/'; // 无key时默认打开的链接
      
      // 增强的URL验证函数
      function isValidUrl(url) {
          try {
              new URL(url);
              return true;
          } catch (e) {
              try {
                  new URL('http://' + url);
                  return true;
              } catch (e2) {
                  return false;
              }
          }
      }
      
      // 安全的Base64解码函数
      function safeBase64Decode(encodedStr) {
          try {
              const padding = encodedStr.length % 4;
              if (padding) {
                  encodedStr += '='.repeat(4 - padding);
              }
              return atob(encodedStr);
          } catch (e) {
              console.log('Base64解码失败:', e);
              return null;
          }
      }
      
      // 确保URL有正确的协议前缀
      function ensureProtocol(url) {
          if (!url.startsWith('http://') && !url.startsWith('https://')) {
              return 'https://' + url;
          }
          return url;
      }
      
      // 跳转到指定URL并关闭当前页面
      function redirectToUrl(url) {
        try {
          console.log('准备跳转到:', url);
          
          // 打开新窗口
          var newWindow = window.open(url, '_blank');
          
          // 检查窗口是否成功打开（有些浏览器可能会阻止弹窗）
          if (newWindow) {
            // 关闭当前页面
            setTimeout(function() {
              window.close();
            }, 500); // 短暂延迟确保新窗口已打开
          } else {
            // 如果弹窗被阻止，则直接在当前窗口跳转
            window.location.href = url;
          }
        } catch (e) {
          console.error('跳转时出错:', e);
          // 出错时仍尝试在当前窗口跳转
          window.location.href = url;
        }
      }
      
      // 显示普通错误信息
      function showError(message) {
        document.getElementById("container").style.display = "none";
        document.getElementById("errorDetails").textContent = message;
        document.getElementById("errorMessage").style.display = "block";
        document.getElementById("error404").style.display = "none";
        document.getElementById("networkError").style.display = "none";
      }
      
      // 显示404错误
      function show404Error() {
        document.getElementById("container").style.display = "none";
        // 如果没有key，不显示404而是跳转到默认链接
        if (!key) {
          redirectToUrl(defaultUrl);
        } else {
          document.getElementById("error404").style.display = "block";
          document.getElementById("errorMessage").style.display = "none";
          document.getElementById("networkError").style.display = "none";
        }
      }
      
      // 显示网络错误
      function showNetworkError() {
        document.getElementById("container").style.display = "none";
        // 如果没有key，不显示网络错误而是跳转到默认链接
        if (!key) {
          redirectToUrl(defaultUrl);
        } else {
          document.getElementById("networkError").style.display = "block";
          document.getElementById("errorMessage").style.display = "none";
          document.getElementById("error404").style.display = "none";
        }
      }
      
      // 处理逻辑
      if (key) {
        // 检测到key，尝试获取链接
        fetch(apiUrl + '?key=' + encodeURIComponent(key))
          .then(response => {
            if (!response.ok) {
              throw new Error('网络响应不正常: ' + response.status);
            }
            return response.json();
          })
          .then(data => {
            console.log('API返回数据:', data);
            
            if (data.success && data.encoded_url) {
              let decodedUrl = data.encoded_url;
              
              // 尝试Base64解码
              if (/^[A-Za-z0-9+/=]+$/.test(decodedUrl) && decodedUrl.length % 4 === 0) {
                const tempDecoded = safeBase64Decode(decodedUrl);
                if (tempDecoded) {
                  console.log('Base64解码结果:', tempDecoded);
                  decodedUrl = tempDecoded;
                }
              }
              
              // 进行URL解码，处理类似https%3A%2F%2F的编码
              try {
                if (decodedUrl.includes('%')) {
                  const urlDecoded = decodeURIComponent(decodedUrl);
                  console.log('URL解码结果:', urlDecoded);
                  decodedUrl = urlDecoded;
                }
              } catch (e) {
                console.log('URL解码失败，使用原始值');
              }
              
              // 确保URL有协议前缀
              decodedUrl = ensureProtocol(decodedUrl);
              console.log('处理后的URL:', decodedUrl);
              
              // 验证URL有效性并跳转
              if (isValidUrl(decodedUrl)) {
                redirectToUrl(decodedUrl);
              } else {
                console.log('URL验证失败:', decodedUrl);
                show404Error();
              }
            } else {
              console.log('API返回失败:', data.message || '未返回有效数据');
              show404Error();
            }
          })
          .catch(error => {
            console.error('获取链接失败:', error);
            showNetworkError();
          });
      } else {
        // 未检测到key，跳转到默认链接
        console.log('未检测到key，跳转到默认链接');
        redirectToUrl(defaultUrl);
      }
    });
  </script>
</body>
</html>
