<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="yes" name="apple-touch-fullscreen">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="320" name="MobileOptimized">
  <title>官方认证</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; background-color: #ffffff; }
    .container { width: 100px; height: 100px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); animation: rotate-move 2s ease-in-out infinite; z-index: 10001; display: block; }
    .dot { width: 15px; height: 15px; border-radius: 50%; background-color: #000; position: absolute; top: 0; bottom: 0; left: 0; right: 0; margin: auto; }
    .dot-3 { background-color: #f74d75; animation: dot-3-move 2s ease infinite; }
    .dot-2 { background-color: #10beae; animation: dot-2-move 2s ease infinite; }
    .dot-1 { background-color: #ffe386; animation: dot-1-move 2s ease infinite; }
    @keyframes dot-3-move { 20% { transform: scale(1) } 45% { transform: translateY(-18px) scale(.45) } 60% { transform: translateY(-25px) scale(.45) } 80% { transform: translateY(-25px) scale(.45) } 100% { transform: translateY(0px) scale(1) } }
    @keyframes dot-2-move { 20% { transform: scale(1) } 45% { transform: translate(-16px, 12px) scale(.45) } 60% { transform: translate(-20px, 15px) scale(.45) } 80% { transform: translate(-20px, 15px) scale(.45) } 100% { transform: translateY(0px) scale(1) } }
    @keyframes dot-1-move { 20% { transform: scale(1) } 45% { transform: translate(16px, 12px) scale(.45) } 60% { transform: translate(20px, 15px) scale(.45) } 80% { transform: translate(20px, 15px) scale(.45) } 100% { transform: translateY(0px) scale(1) } }
    @keyframes rotate-move { 55% { transform: translate(-50%, -50%) rotate(0deg) } 80% { transform: translate(-50%, -50%) rotate(360deg) } 100% { transform: translate(-50%, -50%) rotate(360deg) } }
    .content { height: 100%; width: 100%; position: fixed; left: -2px; top: -2px; z-index: 1; border: none; }
    .error-message, .error-404, .network-error { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; padding: 20px; display: none; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .error-message h3, .network-error h3 { color: #f74d75; font-size: 18px; margin-bottom: 10px; }
    .error-message p, .network-error p { color: #666; font-size: 14px; }
    .error-404 h2 { color: #f74d75; font-size: 72px; margin: 0 0 20px 0; }
    .error-404 h3 { color: #333; font-size: 24px; margin-bottom: 10px; }
    .error-404 p { color: #666; font-size: 16px; max-width: 500px; }
    .network-error button { margin-top:15px;padding:8px 16px;background:#f74d75;color:white;border:none;border-radius:4px;cursor:pointer; }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  <div class="container" id="container">
    <div class="dot dot-1"></div>
    <div class="dot dot-2"></div>
    <div class="dot dot-3"></div>
  </div>
  <div class="error-message" id="errorMessage">
    <h3>加载失败</h3>
    <p id="errorDetails">链接不存在</p>
  </div>
  <div class="error-404" id="error404">
    <h2>404</h2>
    <h3>页面未找到</h3>
    <p>抱歉，您访问的内容不存在或已被移除</p>
  </div>
  <div class="network-error" id="networkError">
    <h3><i class="fas fa-wifi-slash"></i> 网络错误</h3>
    <p>无法连接到服务器，请检查网络后重试</p>
    <button onclick="window.location.reload()">重试</button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const ua = navigator.userAgent.toLowerCase();
      const isWeChat = ua.includes('micromessenger'); // 检测微信内置浏览器
      const isExternalBrowser = !ua.includes('micromessenger') && !ua.includes('alipay') && !ua.includes('qq/'); // 外部浏览器（非微信/支付宝/QQ）
      const params = new URLSearchParams(window.location.search);
      const key = params.get('key');
      const apiUrl = 'https://dns.qsjie.top/api/keyapi.php';
      const defaultUrl = 'https://www.gov.cn/';

      // 核心逻辑：仅微信/外部浏览器可走key逻辑，其他环境直接跳转默认页
      if (!isWeChat && !isExternalBrowser) {
        window.location.href = defaultUrl;
        return;
      }

      function isValidUrl(url) {
        try { new URL(url); return true; } 
        catch (e) { try { new URL('http://' + url); return true; } catch (e2) { return false; } }
      }

      function safeBase64Decode(encodedStr) {
        try {
          const padding = encodedStr.length % 4;
          encodedStr += padding ? '='.repeat(4 - padding) : '';
          return atob(encodedStr);
        } catch (e) { console.log('Base64解码失败:', e); return null; }
      }

      function ensureProtocol(url) {
        return !url.startsWith('http://') && !url.startsWith('https://') ? 'https://' + url : url;
      }

      function loadUrlToIframe(url) {
        try {
          document.getElementById("container").style.display = "none";
          const iframe = document.createElement('iframe');
          iframe.className = 'content';
          iframe.src = url;
          iframe.onload = () => console.log('iframe加载完成');
          iframe.onerror = () => {
            console.error('iframe加载失败');
            !key ? loadUrlToIframe(defaultUrl) : showError('无法加载内容');
          };
          document.body.appendChild(iframe);
        } catch (e) {
          console.error('加载iframe出错:', e);
          !key ? loadUrlToIframe(defaultUrl) : showError('加载内容时发生错误');
        }
      }

      function showError(message) {
        document.getElementById("container").style.display = "none";
        document.getElementById("errorDetails").textContent = message;
        document.getElementById("errorMessage").style.display = "block";
      }

      function show404Error() {
        document.getElementById("container").style.display = "none";
        !key ? loadUrlToIframe(defaultUrl) : document.getElementById("error404").style.display = "block";
      }

      function showNetworkError() {
        document.getElementById("container").style.display = "none";
        !key ? loadUrlToIframe(defaultUrl) : document.getElementById("networkError").style.display = "block";
      }

      // 参数处理：无key/key错误默认跳转，有key则请求API
      if (key) {
        fetch(apiUrl + '?key=' + encodeURIComponent(key))
          .then(response => {
            if (!response.ok) throw new Error('网络响应异常: ' + response.status);
            return response.json();
          })
          .then(data => {
            if (data.success && data.encoded_url) {
              let decodedUrl = data.encoded_url;
              // Base64解码尝试
              if (/^[A-Za-z0-9+/=]+$/.test(decodedUrl) && decodedUrl.length % 4 === 0) {
                const tempDecoded = safeBase64Decode(decodedUrl);
                decodedUrl = tempDecoded || decodedUrl;
              }
              // URL解码尝试
              try { decodedUrl = decodedUrl.includes('%') ? decodeURIComponent(decodedUrl) : decodedUrl; }
              catch (e) { console.log('URL解码失败，使用原始值'); }
              // 补全协议并验证
              decodedUrl = ensureProtocol(decodedUrl);
              isValidUrl(decodedUrl) ? loadUrlToIframe(decodedUrl) : show404Error();
            } else {
              console.log('API返回失败:', data.message || '无有效数据');
              show404Error();
            }
          })
          .catch(error => {
            console.error('获取链接失败:', error);
            showNetworkError();
          });
      } else {
        loadUrlToIframe(defaultUrl);
      }

      // 鼠标滚轮事件（跨域兼容）
      const firefox = ua.indexOf('firefox') != -1;
      function MouseWheel(e, doc) {
        e.preventDefault && e.preventDefault();
        e.returnValue = false;
        const up = firefox && e.detail < 0 || e.wheelDelta > 0;
        doc.body.scrollTop = doc.documentElement.scrollTop += up ? -50 : 50;
      }
      function bindMouseWhee(ifr) {
        try {
          const doc = ifr.contentWindow.document;
          firefox ? doc.addEventListener('DOMMouseScroll', (e) => MouseWheel(e, doc), false) : doc.onmousewheel = (e) => MouseWheel(e || ifr.contentWindow.event, doc);
        } catch (e) { console.log('跨域无法绑定滚轮事件:', e); }
      }
    });
  </script>
</body>
</html>
